# Supabase Integration Setup

This document explains how to set up and use the Supabase integration in the ArtGuard backend.

## Prerequisites

1. A Supabase project with a `scan_history` table
2. Supabase URL and service role key

## Environment Variables

Add the following environment variables to your `.env` file:

```env
SUPABASE_URL=your_supabase_project_url
SUPABASE_SERVICE_KEY=your_supabase_service_role_key
```

## Database Schema

Create a `scan_history` table in your Supabase database with the following structure:

```sql
CREATE TABLE scan_history (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id TEXT NOT NULL,
    artwork_url TEXT NOT NULL,
    result JSONB NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create an index on user_id for faster queries
CREATE INDEX idx_scan_history_user_id ON scan_history(user_id);

-- Create an index on created_at for sorting
CREATE INDEX idx_scan_history_created_at ON scan_history(created_at DESC);
```

## API Endpoints

### 1. Upload Image with Logging
- **URL**: `POST /api/upload/`
- **Description**: Uploads an image and logs the scan to Supabase
- **Parameters**:
  - `image`: Image file (multipart/form-data)
  - `user_id`: User identifier (optional, defaults to 'anonymous')

### 2. Get Scan History
- **URL**: `GET /api/scan-history/?user_id=<user_id>&limit=<limit>`
- **Description**: Retrieves scan history for a specific user
- **Parameters**:
  - `user_id`: User identifier (required)
  - `limit`: Maximum number of records (optional, default: 50)

### 3. Delete Scan Record
- **URL**: `DELETE /api/delete-scan/?scan_id=<scan_id>`
- **Description**: Deletes a specific scan record
- **Parameters**:
  - `scan_id`: UUID of the scan record to delete

## Usage Examples

### Python Usage

```python
from scanner.utils.supabase_client import log_scan_to_supabase, get_user_scan_history

# Log a scan
result = log_scan_to_supabase(
    user_id="user123",
    artwork_url="https://example.com/artwork.jpg",
    result={
        "confidence": 0.95,
        "classification": "original",
        "metadata": {...}
    }
)

# Get user's scan history
history = get_user_scan_history("user123", limit=10)
```

### JavaScript/TypeScript Usage

```javascript
// Upload image with logging
const formData = new FormData();
formData.append('image', imageFile);
formData.append('user_id', 'user123');

const response = await fetch('/api/upload/', {
    method: 'POST',
    body: formData
});

// Get scan history
const historyResponse = await fetch('/api/scan-history/?user_id=user123&limit=20');
const history = await historyResponse.json();

// Delete scan record
const deleteResponse = await fetch('/api/delete-scan/?scan_id=uuid-here', {
    method: 'DELETE'
});
```

## Error Handling

The Supabase client functions return `None` on failure and log errors to the console. The API endpoints handle these errors gracefully and return appropriate HTTP status codes.

## Security Notes

1. Use the service role key only on the backend - never expose it to the frontend
2. The service role key has full access to your database, so keep it secure
3. Consider implementing row-level security (RLS) policies in Supabase for additional security
4. Validate user permissions before allowing access to scan history

## Troubleshooting

1. **Connection Issues**: Verify your Supabase URL and service key are correct
2. **Table Not Found**: Ensure the `scan_history` table exists in your Supabase database
3. **Permission Errors**: Check that your service key has the necessary permissions
4. **Environment Variables**: Make sure the environment variables are properly set and accessible 